<!DOCTYPE html>
	<html lang="en">
		<head>
			<meta charset="utf-8">
		    <title>cleanjs report for file /Users/patrickbrosset/packman/libs/visitorshandler.js</title>
			<style type="text/css">
				body {
					margin: 0;
					padding: 1em;
					font-size: 12px;
					font-family: verdana;
					overflow-x: hidden;
					width: 100%;
					color: #444;
				}
				h1 {
					margin: 0;
					padding: 1em 1em 1em 25px;
				}
				.general {
					padding: 0;
					margin: 0 0 30px 30px;
					list-style-type: none;
					width: 500px;
					color: #222;
				}
				.lines {
					padding: 0;
					margin: 0;
					list-style-type: none;
					width: 10000px;
				}
				.lines .line {
					overflow: hidden;
					padding: 0;
					margin: 0;
					list-style-type: none;
				}
				.lines .line .gutter {
					float: left;
					text-align: right;
					width: 25px;
					padding: 4px 5px 4px 0;
					color: #aaa;
					font-size: 11px;
				}
				.lines .nomessage .gutter {
					color: #ddd;
				}
				.lines .line .messages {
					float: left;
					padding: 0;
					margin: 0;
					list-style-type: none;
					width: 500px;
				}
				.lines .line .messages li, .general li {
					padding: 4px 1em;
					line-height: 13px;
				}
				.lines .line .code {
					float :left;
					margin: 0;
					padding: 0 1em;
					font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
					font-size: 11px;
				}
				.error, .info, .warning {
					border-left: 4px solid #3e93bf;
					background: #eee;
				}
				.warning {
					border-color: #f5931f;
				}
				.error {
					font-weight: bold;
					border-color: #d83e0f;
				}
			</style>
		</head>
		<body>
			<h1>/Users/patrickbrosset/packman/libs/visitorshandler.js | grade A-</h1><ul class='general'><li class='info'>File is 129 lines long</li><li class='info'>22 lines of comments</li><li class='info'>84 lines of code</li><li class='info'>23 empty lines</li><li class='info'>There are 8 functions in the file</li><li class='info'>Longest function is 20 lines long, and shortest one is 1 (average is 7)</li></ul><ul class='lines'><li class='line nomessage'><span class='gutter'>1</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>var clone = require(&quot;./clone.js&quot;);</pre></li><li class='line nomessage'><span class='gutter'>2</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>3</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>4</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>var phases = {</pre></li><li class='line nomessage'><span class='gutter'>5</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // Just after the config is loaded (so that visitors can modify it), this is the very first thing executed</pre></li><li class='line nomessage'><span class='gutter'>6</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onAfterConfigLoaded: &quot;onAfterConfigLoaded&quot;,</pre></li><li class='line nomessage'><span class='gutter'>7</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // At the very start, even before any files have been packaged</pre></li><li class='line nomessage'><span class='gutter'>8</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onStart: &quot;onStart&quot;,</pre></li><li class='line nomessage'><span class='gutter'>9</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // Before starting to package a set of files together</pre></li><li class='line nomessage'><span class='gutter'>10</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onPackageStart: &quot;onPackageStart&quot;,</pre></li><li class='line nomessage'><span class='gutter'>11</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // Before a file is being inserted into a package</pre></li><li class='line nomessage'><span class='gutter'>12</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onFileStart: &quot;onFileStart&quot;,</pre></li><li class='line nomessage'><span class='gutter'>13</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // When inserting the content of a file into a package</pre></li><li class='line nomessage'><span class='gutter'>14</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onFileContent: &quot;onFileContent&quot;,</pre></li><li class='line nomessage'><span class='gutter'>15</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // After a file has been inserted into a package</pre></li><li class='line nomessage'><span class='gutter'>16</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onFileEnd: &quot;onFileEnd&quot;,</pre></li><li class='line nomessage'><span class='gutter'>17</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // After having packaged a set of files together</pre></li><li class='line nomessage'><span class='gutter'>18</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onPackageEnd: &quot;onPackageEnd&quot;,</pre></li><li class='line nomessage'><span class='gutter'>19</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  // At the end, when all packages are done</pre></li><li class='line nomessage'><span class='gutter'>20</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  onEnd: &quot;onEnd&quot;</pre></li><li class='line nomessage'><span class='gutter'>21</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>};</pre></li><li class='line nomessage'><span class='gutter'>22</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>23</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function overrideObject(src, dest) {</pre></li><li class='line nomessage'><span class='gutter'>24</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var newObject = clone.clone(src);</pre></li><li class='line nomessage'><span class='gutter'>25</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>26</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  for(var i in dest) {</pre></li><li class='line nomessage'><span class='gutter'>27</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    newObject[i] = dest[i];</pre></li><li class='line nomessage'><span class='gutter'>28</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  }</pre></li><li class='line nomessage'><span class='gutter'>29</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>30</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return newObject;</pre></li><li class='line nomessage'><span class='gutter'>31</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>32</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>33</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>/**</pre></li><li class='line nomessage'><span class='gutter'>34</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> * Get the &quot;normalized&quot; visitor, so it is safe to call all of its functions</pre></li><li class='line nomessage'><span class='gutter'>35</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> */</pre></li><li class='line nomessage'><span class='gutter'>36</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>37</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function normalizeVisitor(visitor) {</pre></li><li class='line nomessage'><span class='gutter'>38</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var empty = function(callback) {</pre></li><li class='line nomessage'><span class='gutter'>39</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      callback()</pre></li><li class='line nomessage'><span class='gutter'>40</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    };</pre></li><li class='line nomessage'><span class='gutter'>41</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var emptyVisitor = {};</pre></li><li class='line'><span class='gutter'>42</span><ul class='messages'><li class='error'>Name p doesn't mean anything</li></ul><pre class='code'>  for(var p in phases) {</pre></li><li class='line nomessage'><span class='gutter'>43</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    emptyVisitor[phases[p]] = empty;</pre></li><li class='line nomessage'><span class='gutter'>44</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  }</pre></li><li class='line nomessage'><span class='gutter'>45</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return overrideObject(emptyVisitor, visitor);</pre></li><li class='line nomessage'><span class='gutter'>46</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>47</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>48</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>// Is this a visitor from the default packman install</pre></li><li class='line nomessage'><span class='gutter'>49</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>50</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>51</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function isDefaultVisitor(path) {</pre></li><li class='line nomessage'><span class='gutter'>52</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return path.indexOf(&quot;.&quot;) === -1;</pre></li><li class='line nomessage'><span class='gutter'>53</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>54</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>55</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function isAbsolutePath(path) {</pre></li><li class='line nomessage'><span class='gutter'>56</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return path.substring(0, 1) === &quot;/&quot;;</pre></li><li class='line nomessage'><span class='gutter'>57</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>58</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>59</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function getVisitorInstance(visitorPath) {</pre></li><li class='line nomessage'><span class='gutter'>60</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var visitorInstance = {};</pre></li><li class='line nomessage'><span class='gutter'>61</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>62</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  if(isDefaultVisitor(visitorPath)) {</pre></li><li class='line nomessage'><span class='gutter'>63</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    // If this is a default visitor (myVisitor)</pre></li><li class='line nomessage'><span class='gutter'>64</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    var realVisitorPath = &quot;../visitors/&quot; + visitorPath + &quot;.js&quot;;</pre></li><li class='line nomessage'><span class='gutter'>65</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    try {</pre></li><li class='line nomessage'><span class='gutter'>66</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      visitorInstance = require(realVisitorPath);</pre></li><li class='line nomessage'><span class='gutter'>67</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    } catch(e) {</pre></li><li class='line'><span class='gutter'>68</span><ul class='messages'><li class='warning'>Line is more than 120 character long (140). This is hard to read.</li></ul><pre class='code'>      logger.logError(&quot;Built-in visitor &apos;&quot; + visitorPath + &quot;&apos; could not be loaded, packman will run anyway, just skipping this visitor&quot;, e);</pre></li><li class='line nomessage'><span class='gutter'>69</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    }</pre></li><li class='line nomessage'><span class='gutter'>70</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  } else if(!isAbsolutePath(visitorPath)) {</pre></li><li class='line nomessage'><span class='gutter'>71</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    // If the path does not start with / (myVisitor.js or path/to/visitor.js or ./path/to/myvisitor.js)</pre></li><li class='line nomessage'><span class='gutter'>72</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    var realVisitorPath = process.cwd() + &quot;/&quot; + visitorPath;</pre></li><li class='line nomessage'><span class='gutter'>73</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    try {</pre></li><li class='line nomessage'><span class='gutter'>74</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      visitorInstance = require(realVisitorPath);</pre></li><li class='line nomessage'><span class='gutter'>75</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    } catch(e) {</pre></li><li class='line'><span class='gutter'>76</span><ul class='messages'><li class='warning'>Line is more than 120 character long (138). This is hard to read.</li></ul><pre class='code'>      logger.logError(&quot;Custom visitor &apos;&quot; + visitorPath + &quot;&apos; could not be loaded, packman will run anyway, just skipping this visitor&quot;, e);</pre></li><li class='line nomessage'><span class='gutter'>77</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    }</pre></li><li class='line nomessage'><span class='gutter'>78</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  }</pre></li><li class='line nomessage'><span class='gutter'>79</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>80</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  visitorInstance.name = visitorPath;</pre></li><li class='line nomessage'><span class='gutter'>81</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>82</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return visitorInstance;</pre></li><li class='line nomessage'><span class='gutter'>83</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>84</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>85</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>/**</pre></li><li class='line nomessage'><span class='gutter'>86</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> * Try to load custom visitors given an array of file paths, and normalize them as we go</pre></li><li class='line nomessage'><span class='gutter'>87</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> * @param {Array} visitors The list of file paths of visitors to load</pre></li><li class='line nomessage'><span class='gutter'>88</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> * @return {Array} An array of visitor instance</pre></li><li class='line nomessage'><span class='gutter'>89</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> */</pre></li><li class='line nomessage'><span class='gutter'>90</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>91</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function getVisitorInstances(visitors) {</pre></li><li class='line nomessage'><span class='gutter'>92</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var visitorInstances = [];</pre></li><li class='line nomessage'><span class='gutter'>93</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>94</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  for(var i = 0, l = visitors.length; i &lt; l; i++) {</pre></li><li class='line nomessage'><span class='gutter'>95</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    logger.logDebug(&quot;Loading visitor &quot; + visitors[i]);</pre></li><li class='line nomessage'><span class='gutter'>96</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    visitorInstances.push(normalizeVisitor(getVisitorInstance(visitors[i])));</pre></li><li class='line nomessage'><span class='gutter'>97</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  }</pre></li><li class='line nomessage'><span class='gutter'>98</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>99</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  return visitorInstances;</pre></li><li class='line nomessage'><span class='gutter'>100</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>101</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>102</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>/**</pre></li><li class='line nomessage'><span class='gutter'>103</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> * Run all visitors on a given phase, asynchronously</pre></li><li class='line nomessage'><span class='gutter'>104</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'> */</pre></li><li class='line nomessage'><span class='gutter'>105</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>106</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>function runVisitorsOnPhase(phase, visitors, args, callback) {</pre></li><li class='line nomessage'><span class='gutter'>107</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  var visitors = clone.cloneArray(visitors);</pre></li><li class='line nomessage'><span class='gutter'>108</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>109</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  if(visitors.length === 0) {</pre></li><li class='line nomessage'><span class='gutter'>110</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    callback();</pre></li><li class='line nomessage'><span class='gutter'>111</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  } else {</pre></li><li class='line nomessage'><span class='gutter'>112</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    var visitor = visitors.splice(0, 1)[0];</pre></li><li class='line nomessage'><span class='gutter'>113</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    try {</pre></li><li class='line nomessage'><span class='gutter'>114</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      visitor[phases[phase]].apply(null, [function() {</pre></li><li class='line nomessage'><span class='gutter'>115</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>        runVisitorsOnPhase(phase, visitors, args, callback);</pre></li><li class='line nomessage'><span class='gutter'>116</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      }].concat(args));</pre></li><li class='line nomessage'><span class='gutter'>117</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    } catch(e) {</pre></li><li class='line'><span class='gutter'>118</span><ul class='messages'><li class='warning'>Line is more than 120 character long (137). This is hard to read.</li></ul><pre class='code'>      logger.logError(&quot;Visitor &quot; + visitor.name + &quot; crashed on phase &quot; + phase + &quot;\n\twith error: &quot; + e + &quot;\n\twith arguments: &quot; + args);</pre></li><li class='line nomessage'><span class='gutter'>119</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      if(args[0].exitOnFailedVisitor) {</pre></li><li class='line nomessage'><span class='gutter'>120</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>        process.exit(1);</pre></li><li class='line nomessage'><span class='gutter'>121</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      }</pre></li><li class='line nomessage'><span class='gutter'>122</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>      runVisitorsOnPhase(phase, visitors, args, callback);</pre></li><li class='line nomessage'><span class='gutter'>123</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>    }</pre></li><li class='line nomessage'><span class='gutter'>124</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>  }</pre></li><li class='line nomessage'><span class='gutter'>125</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>}</pre></li><li class='line nomessage'><span class='gutter'>126</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'></pre></li><li class='line nomessage'><span class='gutter'>127</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>module.exports.getVisitorInstances = getVisitorInstances;</pre></li><li class='line nomessage'><span class='gutter'>128</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>module.exports.phases = phases;</pre></li><li class='line nomessage'><span class='gutter'>129</span><ul class='messages'><li>&nbsp;</li></ul><pre class='code'>module.exports.runVisitorsOnPhase = runVisitorsOnPhase;</pre></li></ul></body></html>